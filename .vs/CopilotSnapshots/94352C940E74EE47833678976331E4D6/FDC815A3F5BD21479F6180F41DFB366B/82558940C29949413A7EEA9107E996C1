using API_SSO.Context;
using API_SSO.DTO;
using API_SSO.Servicios;
using API_SSO.Servicios.Contratos;
using API_SSO.Services.S3;

namespace API_SSO.Procesos
{
    public class ComprobantePagoProceso
    {
        private readonly IComprobantePagoService<SSOContext> _Comprobanteservice;
        private readonly IConfiguration _configuracion;
        private readonly IInvitacionService _invitacionService;
        private readonly IClienteService<SSOContext> _clienteService;
        private readonly IS3Service _s3Service;

        public ComprobantePagoProceso(IComprobantePagoService<SSOContext> comprobanteservice, IConfiguration configuracion, IInvitacionService invitacionService, IClienteService<SSOContext> clienteService, IS3Service s3Service)
        {
            _Comprobanteservice = comprobanteservice;
            _configuracion = configuracion;
            _invitacionService = invitacionService;
            _clienteService = clienteService;
            _s3Service = s3Service;
        }

        public async Task<RespuestaDTO> SubirComprobante(IFormFile archivo, int idCliente, List<System.Security.Claims.Claim> claims)
        {
            RespuestaDTO respuesta = new RespuestaDTO();
            var IdUsStr = claims.Where(z => z.Type == "idUsuario").ToList();
            if (IdUsStr[0].Value == null)
            {
                respuesta.Descripcion = "Los datos del usuario están incompletos.";
                respuesta.Estatus = false;
                return respuesta;
            }

            if(archivo == null)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el archivo que se va a publicar";
                return respuesta;
            }
            var ext = System.IO.Path.GetExtension(archivo.FileName).ToLower();
            if (!(ext.Contains(".png") || ext.Contains(".jpg") || ext.Contains(".jpeg") || ext.Contains(".pdf")))
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "El tipo de archivo es incorrecto, debe ser pdf, jpg, jpeg o png";
                return respuesta;
            }

            // Simple S3 upload: check bucket configured
            var bucketName = _configuracion["AWS:BucketName"];
            if (string.IsNullOrEmpty(bucketName))
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No está configurado el bucket de AWS en la aplicación (AWS:BucketName).";
                return respuesta;
            }

            string rutaFinal = string.Empty;
            try
            {
                // Use a prefix per client to keep objects organized
                var keyPrefix = $"clientes/{idCliente}";
                rutaFinal = await _s3Service.UploadFileAsync(archivo, keyPrefix, CancellationToken.None);
                if (string.IsNullOrEmpty(rutaFinal))
                {
                    respuesta.Estatus = false;
                    respuesta.Descripcion = "Ocurrió un error al intentar subir el archivo a S3.";
                    return respuesta;
                }
            }
            catch
            {
                respuesta.Descripcion = "Ocurrió un error al intentar subir el archivo.";
                respuesta.Estatus = false;
                return respuesta;
            }

            ComprobantePagoDTO comprobante = new ComprobantePagoDTO
            {
                IdCliente = idCliente,
                UserId = IdUsStr[0].Value,
                Ruta = rutaFinal,
                Estatus =0, //Capturado
                FechaCarga = DateTime.Now,
                IdUsuarioAutorizador = null,
                Eliminado = false,
            };
            var comprobanteCreado = await _Comprobanteservice.CrearYObtener(comprobante);
            if (comprobanteCreado.Id <=0)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "Ocurrió un error al intentar guardar el comprobante";
                return respuesta;
            }
            respuesta.Estatus = true;
            respuesta.Descripcion = "Comprobante guardado exitosamente";
            return respuesta;
        }

        public async Task<RespuestaDTO> CancelaComprobantePago(int idComprobante)
        {
            RespuestaDTO respuesta = new RespuestaDTO();
            var comprobante = await _Comprobanteservice.ObtenerXId(idComprobante);
            if (comprobante.Id <=0)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el comprobante de pago";
                return respuesta;
            }
            comprobante.Estatus =2; //Cancelado
            respuesta = await _Comprobanteservice.Editar(comprobante);
            return respuesta;
        }

        public async Task<RespuestaDTO> AutorizarComprobantePago(int idComprobante, List<System.Security.Claims.Claim> claims, CancellationToken ct)
        {
            RespuestaDTO respuesta = new RespuestaDTO();
            var IdUsStr = claims.Where(z => z.Type == "idUsuario").ToList();
            if (IdUsStr[0].Value == null)
            {
                respuesta.Descripcion = "Los datos del usuario están incompletos.";
                respuesta.Estatus = false;
                return respuesta;
            }
            var comprobante = await _Comprobanteservice.ObtenerXId(idComprobante);
            if (comprobante.Id <=0)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el comprobante de pago";
                return respuesta;
            }
            comprobante.Estatus =1; //Autorizado
            comprobante.IdUsuarioAutorizador = IdUsStr[0].Value;
            respuesta = await _Comprobanteservice.Editar(comprobante);
            if (respuesta.Estatus)
            {
                var cliente = await _clienteService.ObtenerXId(comprobante.IdCliente);
                if(cliente.Id <=0)
                {
                    respuesta.Estatus = false;
                    respuesta.Descripcion = "Ocurrío un error al encontrar al cliente";
                    return respuesta;
                }
                await _invitacionService.CrearYEnviar((string)cliente.Correo, ct);
            }
            return respuesta;
        }
    }
}
