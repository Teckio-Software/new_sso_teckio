using API_SSO.Context;
using API_SSO.DTO;
using API_SSO.Servicios;
using API_SSO.Servicios.Contratos;
using API_SSO.Services.S3;
using Microsoft.Extensions.Logging;

namespace API_SSO.Procesos
{
    public class ComprobantePagoProceso
    {
        private readonly IComprobantePagoService<SSOContext> _Comprobanteservice;
        private readonly IConfiguration _configuracion;
        private readonly IInvitacionService _invitacionService;
        private readonly IClienteService<SSOContext> _clienteService;
        private readonly IS3Service _s3Service;
        private readonly ILogger<ComprobantePagoProceso> _logger;

        public ComprobantePagoProceso(IComprobantePagoService<SSOContext> comprobanteservice, IConfiguration configuracion, IInvitacionService invitacionService, IClienteService<SSOContext> clienteService, IS3Service s3Service, ILogger<ComprobantePagoProceso> logger)
        {
            _Comprobanteservice = comprobanteservice;
            _configuracion = configuracion;
            _invitacionService = invitacionService;
            _clienteService = clienteService;
            _s3Service = s3Service;
            _logger = logger;
        }

        public async Task<RespuestaDTO> SubirComprobante(IFormFile archivo, int idCliente, List<System.Security.Claims.Claim> claims)
        {
            RespuestaDTO respuesta = new RespuestaDTO();

            // Safely obtain user id claim; allow "system" when no authenticated user (useful during client creation)
            var idUsuario = claims?.FirstOrDefault(z => z.Type == "idUsuario")?.Value ?? "system";

            if (string.IsNullOrEmpty(idUsuario))
            {
                idUsuario = "system";
            }

            if (archivo == null)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el archivo que se va a publicar";
                return respuesta;
            }

            // Log file info for debugging
            try
            {
                _logger.LogInformation("SubirComprobante - archivo recibido: {FileName}, longitud: {Length} bytes", archivo.FileName, archivo.Length);
            }
            catch
            {
                // ignore logging errors
            }

            var ext = System.IO.Path.GetExtension(archivo.FileName).ToLower();
            if (!(ext.Contains(".png") || ext.Contains(".jpg") || ext.Contains(".jpeg") || ext.Contains(".pdf")))
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "El tipo de archivo es incorrecto, debe ser pdf, jpg, jpeg o png";
                return respuesta;
            }

            // Simple S3 upload: check bucket configured
            var bucketName = _configuracion["AWS:BucketName"];
            if (string.IsNullOrEmpty(bucketName))
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No está configurado el bucket de AWS en la aplicación (AWS:BucketName).";
                return respuesta;
            }

            string rutaFinal = string.Empty;
            try
            {
                // Use requested key structure: amazon-s3-teckio/empresa/{idCliente}/comprobantes/...
                var keyPrefix = $"amazon-s3-teckio/empresa/{idCliente}/comprobantes";
                rutaFinal = await _s3Service.UploadFileAsync(archivo, keyPrefix, CancellationToken.None);
                if (string.IsNullOrEmpty(rutaFinal))
                {
                    respuesta.Estatus = false;
                    respuesta.Descripcion = "Ocurrió un error al intentar subir el archivo a S3.";
                    return respuesta;
                }
            }
            catch (Exception ex)
            {
                // Log and return error message to help debugging (do not expose secrets in production)
                _logger.LogError(ex, "Error uploading comprobante for cliente {ClienteId}", idCliente);
                respuesta.Descripcion = "Ocurrió un error al intentar subir el archivo: " + ex.Message;
                respuesta.Estatus = false;
                return respuesta;
            }

            ComprobantePagoDTO comprobante = new ComprobantePagoDTO
            {
                IdCliente = idCliente,
                UserId = idUsuario,
                Ruta = rutaFinal,
                Estatus =0, //Capturado
                FechaCarga = DateTime.Now,
                IdUsuarioAutorizador = null,
                Eliminado = false,
            };

            try
            {
                var comprobanteCreado = await _Comprobanteservice.CrearYObtener(comprobante);
                if (comprobanteCreado == null || comprobanteCreado.Id <=0)
                {
                    respuesta.Estatus = false;
                    respuesta.Descripcion = "Ocurrió un error al intentar guardar el comprobante";
                    return respuesta;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error saving comprobante record for cliente {ClienteId}", idCliente);
                respuesta.Estatus = false;
                respuesta.Descripcion = "Ocurrió un error al intentar guardar el comprobante en la base de datos: " + ex.Message;
                return respuesta;
            }

            respuesta.Estatus = true;
            respuesta.Descripcion = "Comprobante guardado exitosamente";
            return respuesta;
        }

        public async Task<RespuestaDTO> CancelaComprobantePago(int idComprobante)
        {
            RespuestaDTO respuesta = new RespuestaDTO();
            var comprobante = await _Comprobanteservice.ObtenerXId(idComprobante);
            if (comprobante.Id <=0)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el comprobante de pago";
                return respuesta;
            }
            comprobante.Estatus =2; //Cancelado
            respuesta = await _Comprobanteservice.Editar(comprobante);
            return respuesta;
        }

        public async Task<RespuestaDTO> AutorizarComprobantePago(int idComprobante, List<System.Security.Claims.Claim> claims, CancellationToken ct)
        {
            RespuestaDTO respuesta = new RespuestaDTO();
            var IdUsStr = claims.Where(z => z.Type == "idUsuario").ToList();
            if (IdUsStr.Count ==0 || string.IsNullOrEmpty(IdUsStr[0].Value))
            {
                respuesta.Descripcion = "Los datos del usuario están incompletos.";
                respuesta.Estatus = false;
                return respuesta;
            }
            var comprobante = await _Comprobanteservice.ObtenerXId(idComprobante);
            if (comprobante.Id <=0)
            {
                respuesta.Estatus = false;
                respuesta.Descripcion = "No se encontró el comprobante de pago";
                return respuesta;
            }
            comprobante.Estatus =1; //Autorizado
            comprobante.IdUsuarioAutorizador = IdUsStr[0].Value;
            respuesta = await _Comprobanteservice.Editar(comprobante);
            if (respuesta.Estatus)
            {
                var cliente = await _clienteService.ObtenerXId(comprobante.IdCliente);
                if (cliente.Id <=0)
                {
                    respuesta.Estatus = false;
                    respuesta.Descripcion = "Ocurrío un error al encontrar al cliente";
                    return respuesta;
                }
                await _invitacionService.CrearYEnviar((string)cliente.Correo, ct);
            }
            return respuesta;
        }
    }
}
