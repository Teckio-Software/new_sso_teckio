using Amazon.S3;
using Amazon.S3.Model;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Threading;
using System.Threading.Tasks;

namespace API_SSO.Services.S3
{
    public class S3Service : IS3Service
    {
        private readonly S3Options _options;
        private readonly IAmazonS3 _s3Client;

        public S3Service(IOptions<S3Options> options, IAmazonS3 s3Client)
        {
            _options = options.Value;
            _s3Client = s3Client;
        }

        public async Task<string> UploadFileAsync(IFormFile file, string keyPrefix, CancellationToken cancellationToken)
        {
            if (file == null || file.Length == 0)
            {
                return string.Empty;
            }

            // Build object key: prefix + timestamp + original filename
            var timestamp = DateTime.UtcNow.ToString("yyyyMMddHHmmssfff");
            var safeFileName = Path.GetFileName(file.FileName);
            var key = string.IsNullOrEmpty(keyPrefix) ? $"{timestamp}_{safeFileName}" : $"{keyPrefix.TrimEnd('/')}/{timestamp}_{safeFileName}";

            // Prepare request
            var putRequest = new PutObjectRequest
            {
                BucketName = _options.BucketName,
                Key = key,
                InputStream = file.OpenReadStream(),
                ContentType = file.ContentType ?? "application/octet-stream",
                AutoCloseStream = true
            };

            // Upload
            await _s3Client.PutObjectAsync(putRequest, cancellationToken);

            // Return public URL (depends on bucket policy). For simplicity, return the key.
            // If bucket is public, you can construct URL like: https://{bucket}.s3.amazonaws.com/{key}
            var url = $"https://{_options.BucketName}.s3.amazonaws.com/{key}";
            return url;
        }
    }
}